name: pydoclint (report only)

on: [push, pull_request]

jobs:
  pydoclint:
    name: pydoclint (report only)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements-dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install pydoclint
        run: |
          python -m pip install --upgrade pip
          python -m pip install pydoclint -c requirements-dev.txt

      - name: Run pydoclint and save raw output (allow violations)
        continue-on-error: true
        run: |
          pydoclint . --style=numpy -v 2>&1 | tee pydoclint-report.txt || true

      - name: Produce JSON summary and fail only on parser crash
        run: |
          python - <<'PY'
          import re, json, sys, pathlib
          p = pathlib.Path('pydoclint-report.txt')
          text = p.read_text(encoding='utf-8') if p.exists() else ''
          # detect parser crash
          crash = False
          crash_tail = []
          if 'Traceback' in text or 'ValueError' in text or 'Exception' in text:
              crash = True
              crash_tail = text.strip().splitlines()[-200:]
          # parse violations: map file -> {code: count}
          violations = {}
          totals = {}
          current_file = None
          file_line_re = re.compile(r'^(?:\./)?([^\s].*\.py)\s*$')
          violation_re = re.compile(r'^\s*(\d+):\s*(DOC\d{3}):')
          for line in text.splitlines():
              mfile = file_line_re.match(line)
              if mfile:
                  current_file = mfile.group(1)
                  continue
              mv = violation_re.match(line)
              if mv and current_file:
                  code = mv.group(2)
                  violations.setdefault(current_file, {})
                  violations[current_file].setdefault(code, 0)
                  violations[current_file][code] += 1
                  totals.setdefault(code, 0)
                  totals[code] += 1
          summary = {
              "crash": crash,
              "crash_tail": crash_tail,
              "violations": violations,
              "totals": totals,
          }
          with open('pydoclint-summary.json', 'w', encoding='utf-8') as fh:
              json.dump(summary, fh, indent=2)
          print("pydoclint summary written to pydoclint-summary.json")
          if crash:
              print("pydoclint parser crash detected; failing job.")
              for l in crash_tail[-50:]:
                  print(l)
              sys.exit(1)
          else:
              print("No parser crash detected; keeping job green for lint violations.")
          PY

      - name: Upload pydoclint raw output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pydoclint-raw
          path: pydoclint-report.txt

      - name: Upload pydoclint JSON summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pydoclint-summary
          path: pydoclint-summary.json
